        ORG 0           ; POZICIJA OD RUTINE ZA RESET IZNIMKU
        B RESET         ; SKOK NA RUTINU ZA RESET

        ORG 0x18        ; POZICIJA ZA RUTINU OD IRQ
        B PREKID        ; SKOK NA RUTINU ZA PREKID                           


RESET   ;INIT SP U SVIM KORISTENIM NACINIMA RADA
        ; INIT SP ZA NACIN RADA IRQ:
        MSR CPSR,#0b11010010            ; PREBACUJEM SE U NACIN RADA IRQ
        MOV SP,#0x10000                 ; INIT SP ZA NACIN RADA IRQ

        ; INIT SP ZA NACIN RADA SVC:
        MSR CPSR,#0b11010011            ; PREBACUJEM SE U NACIN RADA SVC
        MOV SP,#0xFC00                 ; INIT SP ZA NACIN RADA SVC

        ;INIT SVIH VANJSKIHJEDINICA
        ; INIT RTC-a:
                ; LR I MR NAM U POCETKU NISU BITNI ZATO STO SE U PROVM STANJU TO NE GLEDA PA MOGU OSTATI U POCETNOJ VRIJENDOSTI 0
        LDR R0,RTC
        MOV R1,#0
        STR R1,[R0,#16]         ; VRIJEDNOST 0 UPISUJEM U CR TAKO DA ONEMOGUCIM GENERIRANJE PREKIDNIH SIGNALA, ZATO STO NAM U STANJU 1 NE TREBAJU

        ; INIT ZA GPIO1:
             ; POCETNA VRIJENDOST PB_DDR JE 0, STO ZNACI DA SU SVI PINOVI IZLAZNI STO ODGOVARA ZA LCD, NISTA NIJE POTREBNO MIJENJATI

        ; INIT ZA GPIO2:
        LDR R0,GPIO2
        MOV R1,#0b11100000       ; U R1 SE UPISUJE SMJER ZA PA_DDR, PIN 0 POSTAVLJAMO U ULAZ ZA TIPKALO, PINOVE 5, 6, 7 POSTAVLJAMO U IZLAZ ZA LEDICE I SVE OSTALO POSTAVLJAMO U ULAZ
        STR R1,[R0,#8]          ; SMJER ZA PA_DDR IZ R1 UPISUJEM NA LOKACIJU OD PA_DDR

        ;OMOGUCUJEM PREKIDE
        MRS R0,CPSR
        BIC R0,R0,#0b10000000   ; U R0 SPREMAM VRIJEDNOT KOJA CE OMOGUCITI PRIHVACANJE IRQ NA RAZINI PROCESORA
        MSR CPSR,R0             ; U SPSR SPREMAM VRIJENDOST R0, UKLJUCUJEM MOGUCNOST PRIMANJA IRQ PREKIDA NA RAZINI SUSATVA

        ;SKOK U GLAVNI PROGRAM
        B MAIN                  ; SKOK U GLAVNI PROGRAM
        

; DEFINIRANJE ADRESA OD VANJSKIH JEDINICA, ONE CE SE SPREMITI ODMAH POSLIJE NAREDBE ZA SKOK U GLAVNI PROGRAM:
RTC     DW 0xFFFF0E00           ; ADRESA OR RTC-A
GPIO1   DW 0xFFFF0F00           ; ADRESA OR GPIO1
GPIO2   DW 0xFFFF0B00           ; ADRESA OR GPIO2


; DEFINIRAMO ADRESE ZA POHRANJIVANJE STRINGOVA KOJE ZELIMO ISPISATI NA LCD
POCETAK  DSTR "SPREMNO "
PRIPREMA DSTR "PRIPREMA"
GOTOVO   DSTR "GOTOVO  "
GRESKA   DSTR "GRESKA  "      


;!!!!! OVO IZGLEDA DA NIJE BILO POTREBNO KAO NI DEFINIRANJE POSEBNIH MEMORIJSKIH LOKACIJA ZA STANJA
;ZA SADA CU OSTAVIT OVAKO DOK SE NE UVJERIM DA SVE DOBRO RAID BEZ TOGA, I TAKODER CU NASTAVITPISAT MEMORIJSKE LOKAICJE ZA SADA

; DEFINIRAM MJESTO NA KOJU CU IMAT POHRANJENE ADRESE OD PODPROGRAMA ZA SVE CIKLUSUE
PODPROG DW 0x200, 0x600, 0xA00, 0xE00, 0x1200, 0x1600           ; PRVA MEMORIJSKA LOKACIJA ODGOVARA ADRESI PODPOGRAMA ZA STANJE 1 ITD.




; PODPROGRAM ZA ISPISIVANJE STVARI NA LCDU KOJI KORISITI I PODPORGRAM ZA ISPISIVANJE SAMO JEDNOG ZNAKA NA LCDU:
; PODPROGRAM PRNSTR:

PRNSTR  STMFD SP!,{R0,R1,R2,R3,LR}
        MOV R2,#8       ; INICIJALAIZAICJA BROJACA
        MOV R3,R0       ; U R3 MI SE NALAZI ADRESA STIRNGA
        MOV R0,#0x0D
        BL LCDWR 

PETLJA  CMP R0,#0
        BEQ KRAJ_F
        CMP R2,#0
        BEQ KRAJ_F

        LDRB R0,[R3],#1 ; SPRMEI MI VIRJENDOST PRVOG CHARACHTERA I POVECAJ NA SLJEDECI
        SUB R2,R2,#1    ; SMANJUJEM BROJAC
        BL LCDWR
        B PETLJA

KRAJ_F  MOV R0,#0x0A
        BL LCDWR 
        LDMFD SP!,{R0,R1,R2,R3,LR}
        MOV PC,LR


; PODPROGRAM LCDWR;

LCDWR STMFD SP!,{R0}

      BIC R0,R0,#0b10000000
      STR R0,[R1]
      
      ORR R0,R0,#0b10000000
      STR R0,[R1]
      
      BIC R0,R0,#0b10000000
      STR R0,[R1]

END   LDMFD SP!,{R0}
      MOV PC,LR


; DIO KODA U KOJEM CEKAM DA SE PRITISNE TIPKA ZA STANJE 6 ILI DA SE DOGODI PRKEID
CEK_ST_6        CMP R10,#1
                BEQ DOGOD_SE
 
                LDR R0,GPIO2
                LDR R1,[R0,#0]                  ; U R1 SPRMAM STANJE PA_DR
                TST R1,#1                       ; TESTIRAJ MI SADRZAJ REGISTRA R1 SA BROJEM 1, AKO TIPKALO NIJE BILO PRITISNUTNO ONDA CE VRIJENDOST EQ BITI 0
                BEQ CEK_ST_6                    ; AKO TIPKALO NIJE PRITISNUTO CEKAJ DA SE PRITISNE

                ;KADA SE TIPKALO PRITISNE PREDI U STANJE 6
                B STANJE_6

DOGOD_SE        CMP R8,#8
                BEQ STANJE_3

                CMP R8,#12
                BEQ STANJE_4

                CMP R8,#16
                BEQ STANJE_5

                CMP R7,#6
                BEQ STANJE_1

                ;INACE:
                MOV R10,#0                      ; U R10 POSTAVLJAM 0 DA S EOPET MOZE AKTIVIRAT DOGOD_SE
                B CEK_ST_6        
                


; GLAVNI DIO PROGRAMA:

MAIN    MOV R7,#0                       ; R7 CU KORISTITI KAO GLOBALAN REGISTAR, BROJI KOLIKO PUTA SE RTC AKTIVIRAO
        MOV R8,#0                       ; R8 JE TAKODER GLOBALNI REGISTAR, GOVORI U KOJEM STANJU SE NALAZIMO, SVAKO SLJEDECE STANJE JE VECE ZA 4
                                        ; TAKODER SLUZI KAO ODGOVARAJUCI POMAK OD MEMORIJSKE LOKACIJE "STANJA" NA KOJOJ CU ZAPISAIT ADRESE
                                        ; OD PODPROGRAMA SVIH STANJA SLIJEDNO, STANJE 1 JE PREDSTAVLJENO VRIJENDOSCU 0, STANJE 2 VRIJENDOSCU 4 ITD.
        MOV R10,#0                      ; AKO JE U R10 1 DSOLO JE DO PRKEIDA, AKO JE 0 NIJE DOSLO DO PREKIDA      
        B STANJE_1                      ; SKACEM U STANJE 1 I ZAPOCINJEM SVOJ PROGRAM


; PODPROGRAM ZA STANJE 1

 ORG 0x200      ; LOKACIJA OD PROGRAMA ZA STANJE 1 U MEMORIJI S ENALAZI OD ADRESE 0x200
                
STANJE_1        ;POSTVALJAM REGISTAR R10 U 0
                MOV R10,#0
                
                ;ISKLJUCUJEM MOGUCNOST GENERIRANJA PREKIDA KOD RTC-A
                LDR R0,RTC
                MOV R1,#0
                STR R1,[R0,#16]         ; NA ADRESU OD CR UPISUJEM VRIJENDOST 0 TKAO DA UGASIM MOGUCNOST GENERIRANJA PREKIDA

                ;RESETIRAM R7 I R8
                MOV R7,#0               
                MOV R8,#0 

                ;GASIM SVE LEDICE
                LDR R0,GPIO2
                LDR R1,[R0,#0]                  ; U R1 MI PROCITAJ STANJE PA_DR
                BIC R1,R1,#0b11100000           ; ZADNJA 3 BITA POSTAVLJAM U 0 TO C EUGASITI LEDICE KADA SE SPREMI NAZAD NA LOKACIJU OD PA_DR
                STR R1,[R0,#0]                  ; VRIJEDNOST REGISTRA R1 SPREMAM NA MEMORIJSKU LOKACIJU OD PA_DR, EFKTIVNO GASIM LEDICE
        
                ;NA LCD ISPISUJEM PORUKU "SPREMNO"
                MOV R0,#POCETAK                 ; UCITAVAM ADRESU NA KOJOJ SE NALAZI POHRANJENI STIRNG KOJI ZELIMO ISPISATI
                LDR R1,GPIO1
                ADD R1,R1,#4                    ; R1 IMA SPRMELJENU ADRESU OD PB_DR GPIO1 NA KOJU JE POVEZAN LCD

                BL PRNSTR                       ; ISPRINTAJ STIRNG NA LCD

                ;KRECEM U PETLJU KOJU VRTIM SVE DOK SE NE STISNE TIPKALO I ONDA KRECEM U CIKLUS STANJA 1->2->3->4->5->1
CEK_CIKL        LDR R0,GPIO2
                LDR R1,[R0,#0]                  ; U R1 SPRMAM STANJE PA_DR
                TST R1,#1                       ; TESTIRAJ MI SADRZAJ REGISTRA R1 SA BROJEM 1, AKO TIPKALO NIJE BILO PRITISNUTNO ONDA CE VRIJENDOST EQ BITI 0
                BEQ CEK_CIKL                    ; AKO TIPKALO NIJE PRITISNUTO CEKAJ DA SE PRITISNE

                ;KADA SE TIPKALO PRITISNE PREDI U CIKLUS 2
                B STANJE_2



; PODPROGRAM ZA STANJE 2

; ORG 0x600      ; LOKACIJA OD PODPROGRAMA ZA STANJE 2

STANJE_2        ;POSTVALJAM REGISTAR R10 U 0
                MOV R10,#0
                
                ;MIJENJAM VRIJEDNSOTI REGISTARA R7 I R8
                MOV R7,#0               ; U R7 KOJI BROJI KOLIKO SE PUTA RTC AKTIVIRAO STAVLJAM 0
                MOV R8,#4               ; R8 POSTAVLJAM NA VRIJENDOST 4                                      ; !!! OVO SMA ISTO DIRO PA PRIPAZIT, PRIJE JE BILO ZBRAJANJE PLUS 4

                ;POSTAVLJANJE RTC-a
                LDR R0,RTC              ; U R0 UCITAVAM ADRESU OD RTC-a
                MOV R1,#1
                STR R1,[R0,#16]         ; U CR UPISUJEM VRIJEDNOST 1 I TIME OMOGUCAVAM DA RTC GENERIRA ZAHTJEVE ZA PREKID
                MOV R1,#0
                STR R1,[R0,#12]         ; U LR UPISUJEM VRIJEDNOST 0
                MOV R1,#30
                STR R1,[R0,#4]          ; U MR UPISUJEM VRIJEDNOST 30, SOT ZNACI DA CE RTC AKTIVIRAIT ZAHTJEV ZA PREKID KADA DODE DO 30, TJ KADA PRODE 30 SKEUNDI

                ;PALJENJE CRVENE LEDICE
                LDR R0,GPIO2
                LDR R1,[R0,#0]                  ; U R1 UCITAVAM PA_DR
                ORR R1,R1,#0b00100000           ; 5 BIT KOJI ODGOVARA CRVENOJ LEDICI POSTAVLJAM U JEDINICU, OSTALO OSTAVLJAM KAKO JE BILO
                STR R1,[R0,#0]                  ; IZMJENJENO STANJE PA_DR SPREMAM NAZAD NA MEMORIJKSU LOKACIJU OD PA_DR

                ;NA LCD ISPISUJEM PORUKU "PRIPREMA"
                MOV R0,#PRIPREMA                ; UCITAVAM ADRESU NA KOJOJ SE NALAZI POHRANJENI STIRNG KOJI ZELIMO ISPISATI
                LDR R1,GPIO1
                ADD R1,R1,#4                    ; R1 IMA SPRMELJENU ADRESU OD PB_DR GPIO1 NA KOJU JE POVEZAN LCD

                BL PRNSTR                       ; ISPRINTAJ STIRNG NA LCD
                
                ;KRECEM U PETLJU U KOJOJ ISPITUJEM TIPKALO, AKO JE PRITISNUTO PRELAZIM U STANJE 6, ILI SE VRTIM UNUTRA SVE DOK RTC NE DOJAVI PRKEID
                B CEK_ST_6




; PODPROGRAM ZA STANJE 3

; ORG 0xA00      ; LOKACIJA OD PODPROGRAMA ZA STANJE 3

STANJE_3        ;POSTVALJAM REGISTAR R10 U 0
                MOV R10,#0
                
                ;MIJENJAM VRIJEDNSOTI REGISTARA R7 I R8
                MOV R7,#0               ; U R7 KOJI BROJI KOLIKO SE PUTA RTC AKTIVIRAO STAVLJAM 0
                MOV R8,#8               ; U REGISTAR R8 ZAPISUJEM 8 I TIME DOJAVLJUJEM DA SAM U STANJU_3

                ;POSTVALJANJE RTC-a
                        ; prekidi su vec omoguceni
                        ; MR je vec postvaljen na 30
                ;postavljam LR nazad na 0
                LDR R0,RTC
                MOV R1,#0
                STR R1,[R0,#12]         ; U LR UPISUJEM VRIJEDNOST 0
                ;POSTAVLJAM STAT/EOI REGISTAR U 0
                STR R1,[R0,#8]          ; UPISUJEM BILO KOJU VRIJEDNOST U STATUS/OEI REGISTAR TAKO DA GA GA POSTAVIM U 0 I OMOGUCIM KANSIJE PONOVNO PALJENJE

                ;PALJENJE CRVENE I ZUTE LEDICE
                LDR R0,GPIO2
                LDR R1,[R0,#0]                  ; U R1 UCITAVAM PA_DR
                ORR R1,R1,#0b01100000           ; 5 BIT KOJI ODGOVARA CRVENOJ LEDICI POSTAVLJAM U JEDINICU, OSTALO OSTAVLJAM KAKO JE BILO
                STR R1,[R0,#0]                  ; IZMJENJENO STANJE PA_DR SPREMAM NAZAD NA MEMORIJKSU LOKACIJU OD PA_DR                                 

                ;KRECEM U PETLJU U KOJOJ ISPITUJEM TIPKALO, AKO JE PRITISNUTO PRELAZIM U STANJE 6, ILI SE VRTIM UNUTRA SVE DOK RTC NE DOJAVI PRKEID
                B CEK_ST_6                      ; DEFINIRAO SAM MJESTO NA KOJEM CEKAM DA SE PRITINS ETIPA DA ODE U 6 I TKAO SE VRTI DOK SE NE DOGODI PRKEID




; PODPROGRAM ZA STANJE 4

; ORG 0xE00      ; LOKACIJA OD PODPROGRAMA ZA STANJE 4

STANJE_4        ;POSTVALJAM REGISTAR R10 U 0
                MOV R10,#0
                
                ;MIJENJAM VRIJEDNSOTI REGISTARA R7 I R8
                MOV R7,#0               ; U R7 KOJI BROJI KOLIKO SE PUTA RTC AKTIVIRAO STAVLJAM 0
                MOV R8,#12              ; U REGISTAR R8 ZAPISUJEM 12 I TIME DOJAVLJUJEM DA SAM U STANJU_4

                ;POSTVALJANJE RTC-a
                        ; prekidi su vec omoguceni
                        ; MR je vec postvaljen na 30
                ;postavljam LR nazad na 0
                LDR R0,RTC
                MOV R1,#0
                STR R1,[R0,#12]         ; U LR UPISUJEM VRIJEDNOST 0
                ;POSTAVLJAM STAT/EOI REGISTAR U 0
                STR R1,[R0,#8]          ; UPISUJEM BILO KOJU VRIJEDNOST U STATUS/OEI REGISTAR TAKO DA GA GA POSTAVIM U 0 I OMOGUCIM KANSIJE PONOVNO PALJENJE

                ;PALJENJE CRVENE, ZUTE I ZELNE LEDICE
                LDR R0,GPIO2
                LDR R1,[R0,#0]                  ; U R1 UCITAVAM PA_DR
                ORR R1,R1,#0b11100000           ; BITOVE KOJI ODGOVARAJU LEDICAMA POSTAVLJAM U 1 OSTALI BITOVI OSTAJU ONAKVI KAKVI SU BILI
                STR R1,[R0,#0]                  ; IZMJENJENO STANJE PA_DR SPREMAM NAZAD NA MEMORIJKSU LOKACIJU OD PA_DR                                 

                ;KRECEM U PETLJU U KOJOJ ISPITUJEM TIPKALO, AKO JE PRITISNUTO PRELAZIM U STANJE 6, ILI SE VRTIM UNUTRA SVE DOK RTC NE DOJAVI PRKEID
                B CEK_ST_6                      ; DEFINIRAO SAM MJESTO NA KOJEM CEKAM DA SE PRITINS ETIPA DA ODE U 6 I TKAO SE VRTI DOK SE NE DOGODI PRKEID



; PODPROGRAM ZA STANJE 5

; ORG 0x1200      ; LOKACIJA OD PODPROGRAMA ZA STANJE 5

STANJE_5        ;POSTVALJAM REGISTAR R10 U 0
                MOV R10,#0

                ;MIJENJAM VRIJEDNSOTI REGISTARA R7 I R8
                MOV R7,#0               ; U R7 KOJI BROJI KOLIKO SE PUTA RTC AKTIVIRAO STAVLJAM 0
                MOV R8,#16              ; U REGISTAR R8 ZAPISUJEM 12 I TIME DOJAVLJUJEM DA SAM U STANJU_4                

                ;POSTVALJANJE RTC-a
                        ; prekidi su vec omoguceni
                        ; MR je vec postvaljen na 30
                ;postavljam LR nazad na 0
                LDR R0,RTC
                MOV R1,#0
                STR R1,[R0,#12]         ; U LR UPISUJEM VRIJEDNOST 0
                ;POSTAVLJAM STAT/EOI REGISTAR U 0
                STR R1,[R0,#8]          ; UPISUJEM BILO KOJU VRIJEDNOST U STATUS/OEI REGISTAR TAKO DA GA GA POSTAVIM U 0 I OMOGUCIM KANSIJE PONOVNO PALJENJE

                ;LEDICE NE MORAM DIRAT ZATO STO SVE 3 TREBAJU SVIJETILITI A TO RADE OD PRIJE
                
                ;NA LCD ISPISUJEM PORUKU "GOTOVO"
                MOV R0,#GOTOVO                ; UCITAVAM ADRESU NA KOJOJ SE NALAZI POHRANJENI STIRNG KOJI ZELIMO ISPISATI
                LDR R1,GPIO1
                ADD R1,R1,#4                    ; R1 IMA SPRMELJENU ADRESU OD PB_DR GPIO1 NA KOJU JE POVEZAN LCD

                BL PRNSTR                       ; ISPRINTAJ STIRNG NA LCD                

                ;KRECEM U PETLJU U KOJOJ ISPITUJEM TIPKALO, AKO JE PRITISNUTO PRELAZIM U STANJE 6, ILI SE VRTIM UNUTRA SVE DOK RTC NE DOJAVI PRKEID
LOOP_5          CMP R10,#1
                BEQ STIS_6
 
                LDR R0,GPIO2
                LDR R1,[R0,#0]                  ; U R1 SPRMAM STANJE PA_DR
                TST R1,#1                       ; TESTIRAJ MI SADRZAJ REGISTRA R1 SA BROJEM 1, AKO TIPKALO NIJE BILO PRITISNUTNO ONDA CE VRIJENDOST EQ BITI 0
                BEQ LOOP_5                    ; AKO TIPKALO NIJE PRITISNUTO CEKAJ DA SE PRITISNE

                ;KADA SE TIPKALO PRITISNE PREDI U STANJE 6
                B STANJE_6

STIS_6          CMP R7,#6
                BEQ STANJE_1

                ;PROVJERAVAM JELI BROJ U R7 PARAN ILI NEPARAN OVINSO O TOME MU PALIM ILI GASIM LEDICE
                MOVS R5,R7,LSR #1
                ;AKO JE CARRY SET = 1 ONDA LEDICE NE SVIJETLE:
                LDRCS R0,GPIO2
                LDRCS R1,[R0,#0]                  ; U R1 UCITAVAM PA_DR
                BICCS R1,R1,#0b11100000           ; PALIM CRVENU LEDICU A OSTALE DVIJE GASIM
                STRCS R1,[R0,#0]                  ; IZMJENJENO STANJE PA_DR SPREMAM NAZAD NA MEMORIJKSU LOKACIJU OD PA_DR
                ;AKO JE CARRY SET = 0 ONDA CRVENA LEDICA TREBA SVIJETLITI:
                LDRCC R0,GPIO2
                LDRCC R1,[R0,#0]                  ; U R1 UCITAVAM PA_DR
                ORRCC R1,R1,#0b11100000           ; POSTVALJAM SVE LEDICE DA SVIJETLE I ONDA TO SPREMAM NA ODGOVARAJUCU LOKACIJU
                STRCC R1,[R0,#0] 

                ;INACE:
                MOV R10,#0                      ; U R10 POSTAVLJAM 0 DA S EOPET MOZE AKTIVIRAT DOGOD_SE
                B LOOP_5                






; PODPROGRAM ZA STANJE 6


STANJE_6        ;POSTVALJAM REGISTAR R10 U 0
                MOV R10,#0

                ;MIJENJAM VRIJEDNSOTI REGISTARA R7 I R8
                MOV R7,#0               ; U R7 KOJI BROJI KOLIKO SE PUTA RTC AKTIVIRAO STAVLJAM 0
                MOV R8,#20              ; U REGISTAR R8 ZAPISUJEM 12 I TIME DOJAVLJUJEM DA SAM U STANJU_4              

                ;POSTVALJANJE RTC-a
                        ; prekidi su vec omoguceni
                        ; MR je vec postvaljen na 30
                ;postavljam LR nazad na 0
                LDR R0,RTC
                MOV R1,#0
                STR R1,[R0,#12]         ; U LR UPISUJEM VRIJEDNOST 0
                ;POSTAVLJAM STAT/EOI REGISTAR U 0
                STR R1,[R0,#8]          ; UPISUJEM BILO KOJU VRIJEDNOST U STATUS/OEI REGISTAR TAKO DA GA GA POSTAVIM U 0 I OMOGUCIM KANSIJE PONOVNO PALJENJE

                ;PALJENJE CRVENE LEDICE I GASENJE OSTALIH
                LDR R0,GPIO2
                LDR R1,[R0,#0]                  ; U R1 UCITAVAM PA_DR
                ORR R1,R1,#0b00100000           ; 5 BIT KOJI ODGOVARA CRVENOJ LEDICI POSTAVLJAM U JEDINICU, OSTALO OSTAVLJAM KAKO JE BILO
                BIC R1,R1,#0b11000000           ; PALIM CRVENU LEDICU A OSTALE DVIJE GASIM
                STR R1,[R0,#0]                  ; IZMJENJENO STANJE PA_DR SPREMAM NAZAD NA MEMORIJKSU LOKACIJU OD PA_DR                

                ;NA LCD ISPISUJEM PORUKU "GRESKA  "
                MOV R0,#GRESKA                 ; UCITAVAM ADRESU NA KOJOJ SE NALAZI POHRANJENI STIRNG KOJI ZELIMO ISPISATI
                LDR R1,GPIO1
                ADD R1,R1,#4                    ; R1 IMA SPRMELJENU ADRESU OD PB_DR GPIO1 NA KOJU JE POVEZAN LCD

                BL PRNSTR                       ; ISPRINTAJ STIRNG NA LCD

                ;POSEBNA PETLJA ZA STANJE_6
ERR_LOOP        CMP R10,#1
                BEQ VAN_ERR
                B ERR_LOOP

VAN_ERR         CMP R7,#6
                BEQ STANJE_1

                ;PROVJERAVAM JELI BROJ U R7 PARAN ILI NEPARAN OVINSO O TOME MU PALIM ILI GASIM LEDICE
                MOVS R5,R7,LSR #1
                ;AKO JE CARRY SET = 1 ONDA LEDICE NE SVIJETLE:
                LDRCS R0,GPIO2
                LDRCS R1,[R0,#0]                  ; U R1 UCITAVAM PA_DR
                BICCS R1,R1,#0b11100000           ; PALIM CRVENU LEDICU A OSTALE DVIJE GASIM
                STRCS R1,[R0,#0]                  ; IZMJENJENO STANJE PA_DR SPREMAM NAZAD NA MEMORIJKSU LOKACIJU OD PA_DR
                ;AKO JE CARRY SET = 0 ONDA CRVENA LEDICA TREBA SVIJETLITI:
                LDRCC R0,GPIO2
                LDRCC R1,[R0,#0]                  ; U R1 UCITAVAM PA_DR
                ORRCC R1,R1,#0b00100000           ; 5 BIT KOJI ODGOVARA CRVENOJ LEDICI POSTAVLJAM U JEDINICU, OSTALO OSTAVLJAM KAKO JE BILO
                BICCC R1,R1,#0b11000000           ; PALIM CRVENU LEDICU A OSTALE DVIJE GASIM
                STRCC R1,[R0,#0]   

                ;INACE:
                MOV R10,#0                      ; U R10 POSTAVLJAM 0 DA S EOPET MOZE AKTIVIRAT DOGOD_SE
                B ERR_LOOP 




; PODPROGRMA ZA PRKEIDU RUTINU
PREKID          ADD R7,R7,#1                    ; R7 POVECAVAM ZA 1, TJ. POVECAVAM BROJ PRKEIDA OD RTC-a U TRENUTNOM STANJU
                ADD R8,R8,#4                    ; R8 POVECAVAM ZA 4, OZNACAVAM PRELAZAK U SLJEDECE STANJE U CIKLUSU
                MOV R10,#1                       ; REGISTAR R9 DOJAVI DA JE DOSLO DO PRKEIDA

                ;RESETIRAM SVE POTREBEN VRIJENDOSTI ZA RTC, LR POSTAVLJAM U 0 I BRISME STAT/EOI REGISTAR           ; MOZDA DODAT ONO NA SOTG, ALI MISLIM DA NEMA POTREBE PVAKO NA PRVU
                LDR R0,RTC
                MOV R1,#0
                STR R1,[R0,#12]                 ; U LR UPISUJEM VRIJEDNOST 0
                ;POSTAVLJAM STAT/EOI REGISTAR U 0
                STR R1,[R0,#8]                  ; UPISUJEM BILO KOJU VRIJEDNOST U STATUS/OEI REGISTAR TAKO DA GA GA POSTAVIM U 0 I OMOGUCIM KANSIJE PONOVNO PALJENJE


                SUBS PC,LR,#4                   ; VRATI SE U GLAVNI PROGRAM



